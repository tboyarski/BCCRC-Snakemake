# bamUtil Module (Multi-Snakemake)
This directory contains the bamUtil module. It is a multi-module system.

## Modules:
See invidual files for expanded explanations of their purpose and the manner in which they accomplish it.
* alignBAM_bwa: Conversion of a '.fastq' file to a '.bam' file, via BWA-MEM.
* alignBAM_starAligner: Conversion of a '.fastq' file to a '.bam' file, via STAR.
* bam2fastq: Conversion of a '.bam' file to a '.fastq' file.
* cleanBAM: Cleans the provided SAM/BAM, soft-clipping beyond-end-of-reference alignments and setting MAPQ to 0 for unmapped reads.
* fastqc: Run Fastqc on '.bam' files.
* fastq2GZ: Compress a '.fastq' file into a '.fastq.gz' file.
* filteredBAM: Filtering of a '.bam' file on read quality.
* fixmateBAM: Fill in mate coordinates, ISIZE, and mate related flags from a name-sorted alignment.
* indexBAM: Indexing of a '.bam' file.
* markdupBAM: Mark diplicates in a '.bam' file and produce metrics.
* namesortBAM: Produce a name sorted '.bam' file. 
* rmdupBAM: Remove duplicates from a '.bam' file.
* sortBAM_biobambam: Sorting of a '.bam' file, via BIOBAMBAM.
* sortBAM_samtools: Sorting of a '.bam' file, via SAMTOOLS.
* **bamUtil: Master file which includes the modules above.**

## Regression Testing:
Most recently on: **June 21st, 2017**

**Directory Prefix = /genesis/extscratch/clc/projects/tboyarski/RegressionTest/1-bamUtil/bamUtil-**

Please refer the the contained "RegTestREADME" directory for more information about each of the following directories:

    1 = 1-bwa_biobambam_biobambam
    2 = 2-star_samtools_samtools
    3 = 3-RemainingModules

Module | Directory Tested Within
:--------: | :--------:
alignBAM_bwa (default) | 1
alignBAM_bwa (trimReadsFlag) | 3
alignBAM_star | 2
bam2fastq | All
cleanBAM |  3
fastq2GZ | All
fastqc | 3
filteredBAM | 1 & 2
fixmateBAM | 3
indexBAM | All
markdupBAM | 1 & 2
namesortBAM_biobambam | 1
namesortBAM_samtools | 2
rmdupBAM | 3
sortBAM_biobambam | 1
sortBAM_samtools | 2

## Logging:
Will be stored in: "log/bamUtil"

## Control Flags
At times, there will need to exist submodules which only differ by the software they use and
the arguemnts that the respective software requires. To combined this into a single rule is possible
but, for the sake of simplicity and maximum cohesion, they have been seperated into different files.
As these two or more files will all produce the same output, Snakemake cannot otherwise make a choice
as to which of the options it must use. In this case, the following submodules exist with software 
variants. In order to override the default submodule software, users must set the following flags in 
the bamUtil section of the config.yaml file. If/elif/else conditionals were used, as such, the 
value flagged as "default" can be assumed to be contained within the else conditional.

YAML Flag | SubModules | Value required to set
:--------: | :--------: | :--------
SoftwareChoiceFlag_alignBAM | alignBAM_bwa | bwa
SoftwareChoiceFlag_alignBAM | alignBAM_star | STAR
SoftwareChoiceFlag_sortBAM | sortBAM_biobambam | biobambam
SoftwareChoiceFlag_sortBAM | sortBAM_samtools | samtools
SoftwareChoiceFlag_namesortBAM | namesortBAM_biobambam | biobambam
SoftwareChoiceFlag_namesortBAM | namesortBAM_samtools | samtools

## Global Directories:
Module | Argument | Default Value | Description
:--------: | :--------: | :--------: | :--------
All | outputDIR | output | Directory to contain all file generated by the pipeline.
alignBAM, bam2fastq | inputDIR | input | Directory to contain all files prior to starting pipeline (Reference and input files).
indexBAM | bamDIR | bam | Directory to conatin the symlinked and name-normalized '.bam' and '.BAI' files. 
markdup | metricsDIR | metrics | Directory to contain the processed '.metrics' files.

## Global Parameters:
Module | Argument | Default Value | Description
:--------: | :--------: | :--------: | :--------
All | shellCallFile | shellCalls.txt | File to which a copy of all shell calls is printed.
All | offCluster | False | Adds input redirection to end of shell calls as to capture STDERR when not on cluster.
All | intermediateKEEP | False | Remove intermediate files which are not likely to be used after intial processing.
alignBAM | fastqKEEP | False | Flag of 'True' or 'False' on retaining '.fastq' files after they are used in the pipeline.
alignBAM | refFILE | ../path/to/GRCh37-lite.fa | Absolute path to genomic reference file.

## Module Specific Software:
Module | Argument | Default Value | Description
:--------: | :--------: | :--------: | :--------
alignBAM, indexBAM, filteredBAM, namesortBAM, rmdupBAM, sortBAM, bam2fastq | bamUtil_samtoolsProg | samtools | Path to Samtools executable.
cleanBAM, fixmateBAM, bam2fastq | bamUtil_picardProg | picard | Path to Picard executable.
alignBAM | bamUtil_bwaProg | bwa | Path to bwa executable.
fastqc | bamUtil_perlProg | perl | Path to perl executable.
namesortBAM, sortBAM | bamUtil_bamsortProg| bamsort | Path to bamsort executable.
markdupBAM |bamUtil_bammarkduplicates2Prog | bammarkduplicates2 | Path to bammarkduplicates2 executable.

## Module Specific Parameters:
Module | Argument | Default Value | Description
:--------: | :--------: | :--------: | :--------
All | bamDIR | bamUtil | Directory to contain the processed '.bam' files.
alignBAM, bam2fastq | fastqDIR | fastq | Directory to contain the processed '.fastq' files.
alignBAM_* | coreNumber | -t 4 | Number of threads.
alignBAM_* | picardCompatibility | -M | Mark shorter split hits as secondary (for Picard/GATK compatibility)
alignBAM_* | seqPlatform | ILLUMINA | Listed in header information.
alignBAM_* | trimReadsFLAG | False | Flag the trimming of the Fastq files prior to input into BWA.
alignBAM_* | phred64 | -Q 33 | Read quality scoring, alternatively set to: "-Q 64"
alignBAM_* | firstBaseToKeep | -f 1 | Set first base to be kept using: "-f N"
alignBAM_* | lastBaseToKeep | -l 1 | Set last base to be kept using: "-l N"
alignBAM_star | outputSuffixLIST_star | ['_Aligned.out.bam', '_Chimeric.out.junction', '_Chimeric.out.sam', '_Log.final.out', '_Log.out', '_Log.progress.out', '_ReadsPerGene.out.tab','_SJ.out.tab'] | List of output files not required in additional pipeline steps.
fastqc | fastqc | /genesis/clc/usr/fastqc-0.10.1/fastqc.pl | Perl Fastqc script to process a '.bam' file.
fastqc | nogroup | '' | Groups fastqc output based on certian inputs, alternatively set to: "--no-group"
cleanBAM, fixmateBAM, bam2fastq | picardvalStringency | VALIDATION_STRINGENCY=LENIENT | Validation stringency for all SAM files read by this program.
cleanBAM, fixmateBAM, bam2fastq | picardMaxRec | MAX_RECORDS_IN_RAM=5000000 | Specify the number of records stored in RAM before spilling to disk.
filteredBAM | bitFLAG | 512 | Must pass QC threshold.
indexBAM | fileTAG | _realigned_sorted_filtered_markdup | Tag facilitates bamUtil module processing of the '.bam' files in a specific order.
markdupBAM | compressLVL | level=-1 | Default @ -1 (zlib); Can go fast(1) or best(9) using gzip instead.
sortBAM | sortProgFLAG | biobambam | Flag to set whether Samtools(samtools) or Biobambam(biobambam) are used to sort.
bam2fastq | rawBamDIR | rawBam | Directory to contain the unprocessed '.bam' files.
bam2fastq | samtoolsSortMem | 4000000000 | Samtools sort memory allocation of SAM file prior to conversion to ".fastq" format. ** MUST BE REPRESENTED AS AN INTEGER! (NOT 4GB) **
